<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Plants</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        :root {
            --brand-background: #f0f4f0;
            /* Subtle Green */
            --brand-primary: #5d4037;
            /* Tree Bark Brown */
            --brand-primary-dark: #4e342e;
        }

        body {
            background-color: var(--brand-background);
        }

        .container {
            max-width: 720px;
            /* Better layout for desktop */
        }

        .btn-primary {
            background-color: var(--brand-primary);
            border-color: var(--brand-primary);
        }

        .btn-primary:hover {
            background-color: var(--brand-primary-dark);
            border-color: var(--brand-primary-dark);
        }

        .feedback-btn.ok-btn {
            padding-left: 1rem;
            /* Make the button wider */
            padding-right: 1rem;
        }

        .plant-name-wrapper {
            height: 3em;
            /* Accommodate 2 lines of text */
            display: flex;
            align-items: center;
        }

        .plant-name {
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .group-header {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .due-date-text {
            font-size: 0.8em;
        }
    </style>
</head>

<body>

    <div class="container mt-4">
        <!-- Main App UI: Hidden until a file is loaded -->
        <div id="app-content" style="display: none;">
            <div class="row align-items-center mb-3">
                <div class="col">
                    <h1 id="list-title" class="display-5 fw-bold"></h1>
                </div>
                <div class="col-auto">
                    <button id="add-plant-btn" class="btn btn-primary">+</button>
                </div>
            </div>
            <ul id="plant-list" class="list-group"></ul>
        </div>

        <!-- Welcome Screen: Visible by default -->
        <div id="welcome-screen" class="p-5 mb-4 bg-light rounded-3 text-center">
            <div class="container-fluid py-5">
                <h1 class="display-5 fw-bold">My Plants</h1>
                <p class="fs-4">Create a new list or open an existing file to get started.</p>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4">
                    <button id="create-file" class="btn btn-primary btn-lg px-4 gap-3">New File</button>
                    <button id="open-file" class="btn btn-primary btn-lg px-4">Open File</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 Modal for Add/Edit Plant -->
    <div class="modal fade" id="plant-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="plant-form">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dialog-title">Add Plant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id">
                        <div class="mb-3">
                            <label for="plant-name-list" class="form-label">Plant Name:</label>
                            <input class="form-control" list="plant-options" id="plant-name-list" name="name" required
                                placeholder="e.g. Peace Lily or custom name">
                            <datalist id="plant-options">
                                <!-- Options will be populated by JS -->
                            </datalist>
                            <div id="wiki-link-container" class="form-text" style="display: none;">
                                <a id="wiki-link" href="#" target="_blank" rel="noopener noreferrer"></a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="plant-type" class="form-label">Plant Type:</label>
                            <select class="form-select" id="plant-type" name="plantType">
                                <option value="leafy">ü™¥ Leafy Plant</option>
                                <option value="succulent">üåµ Succulent / Cactus</option>
                                <option value="flowering">üåº Flowering Plant</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sunlight" class="form-label">Sunlight:</label>
                            <select class="form-select" id="sunlight" name="sunlight">
                                <option value="low">‚òÅÔ∏è Low Light</option>
                                <option value="indirect">‚õÖÔ∏è Bright, Indirect Light</option>
                                <option value="direct">‚òÄÔ∏è Direct Sun</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="plant-interval" class="form-label">Water Every:</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="plant-interval" name="intervalDays"
                                    required min="1">
                                <span class="input-group-text">days</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="delete-in-modal-btn"
                            class="btn btn-outline-danger me-auto">Delete</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        // --- DATA & STATE ---
        const appState = { fileHandle: null, items: [], editingPlantId: null };
        const plantDatabase = [
            { name: 'Aloe Vera', latinName: 'Aloe vera', wikipedia: 'Aloe_vera', type: 'succulent', sunlight: 'direct', interval: 21 },
            { name: 'Basil', latinName: 'Ocimum basilicum', wikipedia: 'Basil', type: 'leafy', sunlight: 'direct', interval: 4 },
            { name: 'Boston Fern', latinName: 'Nephrolepis exaltata', wikipedia: 'Nephrolepis_exaltata', type: 'leafy', sunlight: 'indirect', interval: 7 },
            { name: 'Chinese Money Plant', latinName: 'Pilea peperomioides', wikipedia: 'Pilea_peperomioides', type: 'leafy', sunlight: 'indirect', interval: 9 },
            { name: 'Common Ivy', latinName: 'Hedera helix', wikipedia: 'Hedera_helix', type: 'leafy', sunlight: 'indirect', interval: 7 },
            { name: 'Fiddle Leaf Fig', latinName: 'Ficus lyrata', wikipedia: 'Ficus_lyrata', type: 'leafy', sunlight: 'indirect', interval: 10 },
            { name: 'Golden Pothos', latinName: 'Epipremnum aureum', wikipedia: 'Epipremnum_aureum', type: 'leafy', sunlight: 'indirect', interval: 8 },
            { name: 'Monstera Deliciosa', latinName: 'Monstera deliciosa', wikipedia: 'Monstera_deliciosa', type: 'leafy', sunlight: 'indirect', interval: 9 },
            { name: 'Orchid', latinName: 'Orchidaceae', wikipedia: 'Orchidaceae', type: 'flowering', sunlight: 'indirect', interval: 10 },
            { name: 'Parlor Palm', latinName: 'Chamaedorea elegans', wikipedia: 'Chamaedorea_elegans', type: 'leafy', sunlight: 'low', interval: 8 },
            { name: 'Peace Lily', latinName: 'Spathiphyllum', wikipedia: 'Spathiphyllum', type: 'leafy', sunlight: 'low', interval: 7 },
            { name: 'Porcelain Flower', latinName: 'Hoya carnosa', wikipedia: 'Hoya_carnosa', type: 'flowering', sunlight: 'indirect', interval: 12 },
            { name: 'Rubber Plant', latinName: 'Ficus elastica', wikipedia: 'Ficus_elastica', type: 'leafy', sunlight: 'indirect', interval: 10 },
            { name: 'Snake Plant', latinName: 'Dracaena trifasciata', wikipedia: 'Dracaena_trifasciata', type: 'succulent', sunlight: 'low', interval: 14 },
            { name: 'Spider Plant', latinName: 'Chlorophytum comosum', wikipedia: 'Chlorophytum_comosum', type: 'leafy', sunlight: 'indirect', interval: 7 },
            { name: 'White Bird of Paradise', latinName: 'Strelitzia nicolai', wikipedia: 'Strelitzia_nicolai', type: 'leafy', sunlight: 'indirect', interval: 7 },
            { name: 'ZZ Plant', latinName: 'Zamioculcas', wikipedia: 'Zamioculcas', type: 'succulent', sunlight: 'low', interval: 18 },
        ];

        // --- DOM ELEMENTS ---
        const createBtn = document.getElementById('create-file');
        const openBtn = document.getElementById('open-file');
        const listTitleEl = document.getElementById('list-title');
        const plantListEl = document.getElementById('plant-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const appContent = document.getElementById('app-content');
        const addPlantBtn = document.getElementById('add-plant-btn');
        const plantForm = document.getElementById('plant-form');
        const plantModalEl = document.getElementById('plant-modal');
        const plantModal = new bootstrap.Modal(plantModalEl);
        const wikiLinkContainer = document.getElementById('wiki-link-container');
        const wikiLink = document.getElementById('wiki-link');
        const deleteInModalBtn = document.getElementById('delete-in-modal-btn');

        // --- CORE FILE & UI LOGIC ---
        async function saveFile() {
            if (!appState.fileHandle) return;
            const writable = await appState.fileHandle.createWritable();
            await writable.write(JSON.stringify(appState.items, null, 2));
            await writable.close();
        }

        async function loadFileContent(fileHandle) {
            const file = await fileHandle.getFile();
            const content = await file.text();
            appState.items = content ? JSON.parse(content) : [];
            renderPlantList();
        }

        function showAppUI() {
            welcomeScreen.style.display = 'none';
            appContent.style.display = 'block';
            listTitleEl.textContent = appState.fileHandle.name.replace(/\.json$/i, '');
        }

        // --- APPLICATION LOGIC ---
        function isSameDay(d1, d2) {
            // Strip time component for accurate day comparison
            const date1 = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
            const date2 = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
            return date1.getTime() === date2.getTime();
        }

        function getLastWatered(plant) {
            if (!plant.wateringHistory || plant.wateringHistory.length === 0) return null;
            return new Date(plant.wateringHistory[plant.wateringHistory.length - 1]);
        }

        function renderPlantList() {
            plantListEl.innerHTML = '';
            if (appState.items.length === 0) return;

            const sortedPlants = [...appState.items].sort((a, b) => new Date(a.nextDue) - new Date(b.nextDue));

            const groups = { overdue: [], today: [], tomorrow: [], next7Days: [], future: [] };
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 1 * 24 * 60 * 60 * 1000);
            const nextWeek = new Date(today.getTime() + 8 * 24 * 60 * 60 * 1000);

            sortedPlants.forEach(plant => {
                const dueDate = new Date(plant.nextDue);
                if (dueDate < today) groups.overdue.push(plant);
                else if (isSameDay(dueDate, today)) groups.today.push(plant);
                else if (isSameDay(dueDate, tomorrow)) groups.tomorrow.push(plant);
                else if (dueDate < nextWeek) groups.next7Days.push(plant);
                else groups.future.push(plant);
            });

            const renderGroup = (title, plants, isOverdue = false) => {
                if (plants.length === 0) return;

                const titleClass = isOverdue ? 'list-group-item-danger' : 'list-group-item-light';
                plantListEl.insertAdjacentHTML('beforeend', `<li class="list-group-item ${titleClass} text-center group-header">${title}</li>`);

                plants.forEach(plant => {
                    const dueDate = new Date(plant.nextDue);
                    const lastWateredDate = getLastWatered(plant);
                    const isWateredToday = lastWateredDate && isSameDay(lastWateredDate, now);

                    const feedbackButtons = `
                        <div class="btn-group" role="group">
                            <button class="feedback-btn btn btn-sm btn-outline-secondary" data-id="${plant.id}" data-feedback="dry" title="Soil was dry">üåµ</button>
                            <button class="feedback-btn btn btn-sm btn-outline-secondary ok-btn" data-id="${plant.id}" data-feedback="ok" title="Soil was just right">üëå</button>
                            <button class="feedback-btn btn btn-sm btn-outline-secondary" data-id="${plant.id}" data-feedback="soggy" title="Soil was soggy">üíß</button>
                        </div>`;

                    const wateredMessage = `<div class="text-success small">Watered today!</div>`;

                    const itemHtml = `
                        <li class="list-group-item d-flex align-items-center">
                            <div class="flex-grow-1">
                                <div class="plant-name-wrapper">
                                    <strong class="fs-5 plant-name">${plant.name}</strong>
                                </div>
                                <div class="small text-body-secondary due-date-text">
                                    ${title !== 'Today' ? `Due: ${dueDate.toLocaleDateString()}` : ''}
                                </div>
                            </div>
                            <div class="plant-actions d-flex align-items-center">
                                ${isWateredToday ? wateredMessage : feedbackButtons}
                                <div class="btn-group ms-2" role="group">
                                    <button class="snooze-btn btn btn-sm btn-outline-secondary" data-id="${plant.id}" title="Snooze by 1 day">üò¥</button>
                                </div>
                                <button class="edit-btn btn btn-sm btn-outline-secondary ms-2" data-id="${plant.id}" title="Edit">‚úèÔ∏è</button>
                            </div>
                        </li>
                    `;
                    plantListEl.insertAdjacentHTML('beforeend', itemHtml);
                });
            };

            renderGroup('Overdue', groups.overdue, true);
            renderGroup('Today', groups.today);
            renderGroup('Tomorrow', groups.tomorrow);
            renderGroup('Next 7 Days', groups.next7Days);
            renderGroup('Future', groups.future);
        }

        function savePlant(event) {
            event.preventDefault();
            const formData = new FormData(plantForm);
            const id = formData.get('id');
            const plantData = {
                name: formData.get('name'),
                plantType: formData.get('plantType'),
                sunlight: formData.get('sunlight'),
                intervalDays: parseInt(formData.get('intervalDays'), 10),
            };

            if (id) {
                const plant = appState.items.find(p => p.id === id);
                Object.assign(plant, plantData);
                const lastWateredDate = getLastWatered(plant);
                if (lastWateredDate) {
                    plant.nextDue = new Date(lastWateredDate.getTime() + plant.intervalDays * 24 * 60 * 60 * 1000).toISOString();
                }
            } else {
                appState.items.push({
                    id: crypto.randomUUID(),
                    wateringHistory: [],
                    ...plantData,
                    nextDue: new Date().toISOString(),
                });
            }

            plantModal.hide();
            renderPlantList();
            saveFile();
        }

        function handleWateringFeedback(id, feedback) {
            const plant = appState.items.find(p => p.id === id);
            if (!plant) return;

            if (!plant.wateringHistory) plant.wateringHistory = [];
            plant.wateringHistory.push(new Date().toISOString());

            if (feedback === 'dry' && plant.intervalDays > 1) {
                plant.intervalDays -= 1;
            } else if (feedback === 'soggy') {
                plant.intervalDays += 1;
            }

            const lastWateredDate = getLastWatered(plant);
            plant.nextDue = new Date(lastWateredDate.getTime() + plant.intervalDays * 24 * 60 * 60 * 1000).toISOString();

            renderPlantList();
            saveFile();
        }

        function snoozePlant(id) {
            const plant = appState.items.find(p => p.id === id);
            if (plant) {
                plant.nextDue = new Date(new Date().getTime() + 1 * 24 * 60 * 60 * 1000).toISOString();
                renderPlantList();
                saveFile();
            }
        }

        function editPlant(id) {
            appState.editingPlantId = id;
            const plant = appState.items.find(p => p.id === id);
            if (plant) {
                plantForm.id.value = plant.id;
                plantForm.name.value = plant.name;
                plantForm.plantType.value = plant.plantType;
                plantForm.sunlight.value = plant.sunlight;
                plantForm.intervalDays.value = plant.intervalDays;
                plantModalEl.querySelector('.modal-title').textContent = 'Edit Plant';
                deleteInModalBtn.style.display = 'block';
                handlePlantSelection({ target: { value: plant.name } });
                plantModal.show();
            }
        }

        function deletePlant(id) {
            if (window.confirm("Are you sure you want to delete this plant?")) {
                appState.items = appState.items.filter(p => p.id !== id);
                plantModal.hide();
                renderPlantList();
                saveFile();
            }
        }

        function populatePlantDatalist() {
            const datalist = document.getElementById('plant-options');
            plantDatabase.sort((a, b) => a.name.localeCompare(b.name));
            plantDatabase.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant.name;
                datalist.appendChild(option);
            });
        }

        function handlePlantSelection(event) {
            const selectedPlantName = event.target.value;
            const plantData = plantDatabase.find(p => p.name === selectedPlantName);
            if (plantData) {
                plantForm.plantType.value = plantData.type;
                plantForm.sunlight.value = plantData.sunlight;
                plantForm.intervalDays.value = plantData.interval;

                const url = `https://en.wikipedia.org/wiki/${plantData.wikipedia}`;
                wikiLink.href = url;
                wikiLink.textContent = url.replace('https://', '');
                wikiLinkContainer.style.display = 'block';
            } else {
                wikiLinkContainer.style.display = 'none';
            }
        }

        // --- EVENT LISTENERS ---
        createBtn.addEventListener('click', async () => {
            try {
                appState.fileHandle = await window.showSaveFilePicker({ suggestedName: 'My Plants.json' });
                appState.items = [];
                await saveFile();
                renderPlantList();
                showAppUI();
            } catch (err) { console.info("Save file picker cancelled."); }
        });

        openBtn.addEventListener('click', async () => {
            try {
                const [handle] = await window.showOpenFilePicker();
                appState.fileHandle = handle;
                await loadFileContent(handle);
                showAppUI();
            } catch (err) { console.info("Open file picker cancelled."); }
        });

        addPlantBtn.addEventListener('click', () => {
            appState.editingPlantId = null;
            plantForm.reset();
            plantForm.id.value = '';
            wikiLinkContainer.style.display = 'none';
            deleteInModalBtn.style.display = 'none';
            plantModalEl.querySelector('.modal-title').textContent = 'Add Plant';
            plantModal.show();
        });

        plantForm.addEventListener('submit', savePlant);
        document.getElementById('plant-name-list').addEventListener('input', handlePlantSelection);
        deleteInModalBtn.addEventListener('click', () => {
            if (appState.editingPlantId) {
                deletePlant(appState.editingPlantId);
            }
        });

        plantListEl.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            if (!id) return;

            if (button.classList.contains('edit-btn')) editPlant(id);
            if (button.classList.contains('snooze-btn')) snoozePlant(id);
            if (button.classList.contains('feedback-btn')) {
                handleWateringFeedback(id, button.dataset.feedback);
            }
        });

        // --- INITIALIZATION ---
        populatePlantDatalist();
    </script>
</body>

</html>